name: Build & Push to Yandex Container Registry

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: code-collab-hub
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install yc (Yandex Cloud CLI)
        run: |
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
          echo "${HOME}/.yandex-cloud/bin" >> $GITHUB_PATH

      - name: Authenticate with Yandex Cloud
        run: |
          echo "${{ secrets.YC_SA_KEY }}" > $HOME/yc-key.json
          yc auth activate-service-account --key-file $HOME/yc-key.json
          yc config set folder-id ${{ secrets.YC_FOLDER_ID }}
        env:
          YC_SA_KEY: ${{ secrets.YC_SA_KEY }}

      - name: Container Registry login
        run: |
          # Logs into Docker using yc CLI credentials
          eval "$(yc container registry get-login --registry-name ${{ secrets.YC_REGISTRY_NAME }} --folder-id ${{ secrets.YC_FOLDER_ID }})"
        env:
          YC_REGISTRY_NAME: ${{ secrets.YC_REGISTRY_NAME }}

      - name: Build Docker image
        run: |
          IMAGE=${{ secrets.YC_REGISTRY_URL }}/$IMAGE_NAME:${GITHUB_SHA}
          docker build -t $IMAGE .
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

      - name: Push Docker image
        run: |
          docker push $IMAGE

      - name: Tag as latest and push
        run: |
          docker tag $IMAGE ${{ secrets.YC_REGISTRY_URL }}/$IMAGE_NAME:latest
          docker push ${{ secrets.YC_REGISTRY_URL }}/$IMAGE_NAME:latest

      - name: Set output image
        run: echo "IMAGE=${{ secrets.YC_REGISTRY_URL }}/$IMAGE_NAME:${GITHUB_SHA}" >> $GITHUB_OUTPUT

      - name: Create or update Yandex Serverless Container service
        run: |
          SERVICE_NAME=${{ secrets.YC_SERVICE_NAME }}
          IMAGE_URL=${{ secrets.YC_REGISTRY_URL }}/$IMAGE_NAME:${GITHUB_SHA}
          # Create service if it doesn't exist
          if ! yc serverless container get --name $SERVICE_NAME --folder-id ${{ secrets.YC_FOLDER_ID }} >/dev/null 2>&1; then
            yc serverless container create --name $SERVICE_NAME --folder-id ${{ secrets.YC_FOLDER_ID }} --memory 512M --concurrency 50 --region ${{ secrets.YC_REGION }}
          fi
          # Create a new version pointing to the new image
          yc serverless container version create --service-name $SERVICE_NAME --container-image $IMAGE_URL
        env:
          YC_SA_KEY: ${{ secrets.YC_SA_KEY }}
          YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
          YC_REGION: ${{ secrets.YC_REGION }}
          YC_SERVICE_NAME: ${{ secrets.YC_SERVICE_NAME }}
